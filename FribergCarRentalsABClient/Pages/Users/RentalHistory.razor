@page "/myrentals"
@using FribergCarRentalsABClient.Models
@using FribergCarRentalsABClient.Services.Base
@using FribergCarRentalsABClient.Services.Rental
@using FribergCarRentalsABClient.Services.Users
@attribute [Authorize]

@inject IUserService UserService
@inject IRentalService RentalService
@inject IJSRuntime JSRuntime
@inject NavigationManager NavManager

<PageTitle>My Rental History</PageTitle>

<h3>My Rental History</h3>
<p>View the status and details of all current and past car rentals associated with your account.</p>

<hr />

@if (IsLoading)
{
    <p class="text-info">Loading your rental history...</p>
}
else if (Rentals == null)
{
    <div class="alert alert-danger">Error loading rental history. Please try again.</div>
}
else if (!Rentals.Any())
{
    <div class="alert alert-info">You have no recorded rentals. Start your first booking today!</div>
}
else
{
    <table class="table table-striped table-hover shadow-sm">
        <thead class="table-dark">
            <tr>
                <th>Car Details</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Status</th>
                <th>Total Cost</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var rental in Rentals)
            {
                <tr>
                    <td>@rental.CarDetails</td>
                    <td>@rental.StartDate.ToString("yyyy-MM-dd")</td>
                    <td>@rental.EndDate.ToString("yyyy-MM-dd")</td>
                    <td>
                        <span class="badge @GetStatusClass(rental.Status)">
                            @rental.Status
                        </span>
                    </td>
                    <td>$@rental.TotalCost.ToString("N2")</td>
                    <td>
                        @if (rental.Status.Equals("Pending", StringComparison.OrdinalIgnoreCase))
                        {
                            <button class="btn btn-sm btn-outline-danger ms-2" @onclick="() => CancelRental(rental.RentalId)">Cancel</button>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>

    @if (!string.IsNullOrEmpty(ResultMessage))
    {
        <div class="mt-3 alert @(IsSuccess ? "alert-success" : "alert-danger")">@ResultMessage</div>
    }
}

@code {
    private List<RentalViewDto> Rentals;
    private bool IsLoading = true;
    private string ResultMessage = string.Empty;
    private bool IsSuccess = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadRentalsAsync();
    }

    private async Task LoadRentalsAsync()
    {
        IsLoading = true;
        ResultMessage = string.Empty;

        try
        {
            Rentals = await RentalService.GetMyRentalsAsync();
        }
        catch (Exception ex)
        {
            ResultMessage = $"Failed to load rentals: {ex.Message}";
            Rentals = new List<RentalViewDto>();
        }
        finally
        {
            IsLoading = false;
        }
    }

    private string GetStatusClass(string status)
    {
        return status.ToLowerInvariant() switch
        {
            "active" => "bg-success",
            "pending" => "bg-warning text-dark",
            "completed" => "bg-secondary",
            "canceled" => "bg-danger",
            _ => "bg-info"
        };
    }

    private async Task CancelRental(int rentalId)
    {
        IsSuccess = false;
        ResultMessage = string.Empty;
        if (await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to cancel this booking? This action cannot be undone."))
        {
            try
            {
                bool success = await RentalService.CancelRentalAsync(rentalId);
                if (success)
                {
                    IsSuccess = true;
                    ResultMessage = $"Rental #{rentalId} was successfully canceled.";
                    await LoadRentalsAsync();
                }
                else
                {
                    IsSuccess = false;
                    ResultMessage = $"Failed to cancel rental #{rentalId}. It may no longer be cancellable.";
                }
            }
            catch (Exception ex)
            {
                IsSuccess = false;
                ResultMessage = $"Error canceling rental: {ex.Message}";
            }
        }
    }
}